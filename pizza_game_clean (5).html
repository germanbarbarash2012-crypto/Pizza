<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêò –ü–æ–∫–æ—Ä–º–∏ –°–ª–æ–Ω–∞ –ü–∏—Ü—Ü–æ–π!</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Comic Sans MS',cursive; background:linear-gradient(135deg,#ffeaa7,#fdcb6e); min-height:100vh; padding:20px; }
.hidden { display:none !important; }

/* AUTH */
#authScreen { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:9999; }
.auth-box { background:white; padding:40px; border-radius:20px; width:380px; max-width:95vw; box-shadow:0 20px 60px rgba(0,0,0,0.4); }
.auth-box h2 { text-align:center; color:#d63031; margin-bottom:20px; font-size:1.8em; }
.auth-tabs { display:flex; gap:10px; margin-bottom:20px; }
.auth-tab { flex:1; padding:12px; background:#dfe6e9; border:none; border-radius:10px; cursor:pointer; font-size:1em; font-weight:700; font-family:inherit; transition:all 0.3s; }
.auth-tab.active { background:#d63031; color:white; }
.auth-form { display:none; flex-direction:column; gap:12px; }
.auth-form.active { display:flex; }
.auth-form input { padding:12px; border:2px solid #dfe6e9; border-radius:10px; font-size:1em; font-family:inherit; outline:none; }
.auth-form input:focus { border-color:#d63031; }
.auth-form button { padding:14px; background:#00b894; color:white; border:none; border-radius:10px; font-size:1.1em; font-weight:700; cursor:pointer; font-family:inherit; transition:all 0.3s; }
.auth-form button:hover { background:#00a383; transform:scale(1.02); }
.msg { padding:10px; border-radius:8px; text-align:center; font-weight:700; display:none; }
.msg.show { display:block; }
.msg.error { background:#ff7675; color:white; }
.msg.success { background:#00b894; color:white; }

/* GAME */
#gameScreen { display:none; max-width:1100px; margin:0 auto; }
.header { background:white; padding:20px; border-radius:20px; text-align:center; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
.header h1 { font-size:2em; color:#d63031; margin-bottom:10px; }
.stats { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; }
.stat { background:#ffeaa7; padding:8px 20px; border-radius:15px; font-weight:700; }
.tabs { display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; }
.tab { flex:1; min-width:100px; padding:12px; background:white; border:none; border-radius:12px; cursor:pointer; font-size:1em; font-weight:700; font-family:inherit; box-shadow:0 3px 10px rgba(0,0,0,0.1); transition:all 0.3s; }
.tab.active { background:#d63031; color:white; transform:translateY(-2px); }
.panel { display:none; background:white; padding:25px; border-radius:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); min-height:400px; }
.panel.active { display:block; }
.btn { padding:10px 20px; border:none; border-radius:10px; font-size:1em; font-weight:700; cursor:pointer; font-family:inherit; transition:all 0.3s; }
.btn:hover { transform:scale(1.05); opacity:0.9; }
.btn-green { background:#00b894; color:white; }
.btn-red { background:#d63031; color:white; }
.btn-blue { background:#0984e3; color:white; }

/* PIZZA */
.pizza-wrap { display:flex; flex-direction:column; align-items:center; }
.pizza-circle { width:280px; height:280px; border-radius:50%; background:radial-gradient(circle,#FFE4B5,#F4A460); border:6px solid #8B4513; position:relative; overflow:hidden; margin:20px auto; box-shadow:0 8px 25px rgba(0,0,0,0.2); transition: transform 0.5s, opacity 0.5s; }

/* OVEN ANIMATION */
#ovenOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9998; flex-direction:column; align-items:center; justify-content:center; }
#ovenOverlay.show { display:flex; }
.oven-box { background:#2d2d2d; border-radius:24px; padding:40px; text-align:center; width:340px; box-shadow:0 20px 60px rgba(0,0,0,0.6); border:3px solid #444; }
.oven-top { font-size:1em; color:#aaa; margin-bottom:10px; font-family:"Comic Sans MS",cursive; font-weight:700; }
.oven-door { width:220px; height:220px; background:#111; border-radius:16px; margin:0 auto 20px; border:4px solid #555; position:relative; overflow:hidden; }
.oven-glass { position:absolute; inset:8px; border-radius:10px; background:rgba(255,100,0,0.08); border:2px solid rgba(255,150,0,0.2); overflow:hidden; }
.oven-fire { position:absolute; bottom:0; left:0; right:0; height:60px; background:linear-gradient(to top,#ff4500,#ff8c00,transparent); opacity:0; border-radius:0 0 10px 10px; animation:fireFlicker 0.3s ease-in-out infinite alternate; }
@keyframes fireFlicker { 0%{opacity:0.6;height:55px} 100%{opacity:1;height:70px} }
.oven-pizza { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:5em; transition:all 0.5s; }
.oven-temp { color:#ff8c00; font-size:1.3em; font-weight:700; font-family:"Comic Sans MS",cursive; margin-bottom:15px; }
.oven-progress-wrap { background:#444; border-radius:20px; height:18px; overflow:hidden; margin-bottom:15px; }
.oven-progress { height:100%; width:0%; background:linear-gradient(90deg,#ff4500,#ff8c00,#ffd700); border-radius:20px; transition:width 0.1s linear; }
.oven-status { color:white; font-size:1em; font-family:"Comic Sans MS",cursive; font-weight:700; min-height:28px; }
.oven-sparks { position:absolute; inset:0; pointer-events:none; }
.spark { position:absolute; width:4px; height:4px; border-radius:50%; background:#ffd700; animation:sparkFly 0.8s ease-out forwards; }
@keyframes sparkFly {
  0%   { transform:translate(0,0) scale(1); opacity:1; }
  100% { transform:translate(var(--sx),var(--sy)) scale(0); opacity:0; }
}
.topping { position:absolute; font-size:1.8em; pointer-events:none; transform:translate(-50%,-50%); }
.ing-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:18px; margin:15px 0; width:100%; max-width:500px; }
.ing-btn { padding:18px 12px; background:white; border:2px solid #ddd; border-radius:12px; cursor:pointer; font-size:1.8em; text-align:center; transition:all 0.3s; font-family:inherit; }
.ing-btn:hover:not(:disabled) { transform:scale(1.1); border-color:#d63031; background:#fff5f5; }
.ing-btn:disabled { opacity:0.3; cursor:not-allowed; }
.ing-btn .cnt { font-size:0.4em; display:block; }
.cook-btns { display:flex; gap:10px; }

/* SHOP / INV */
.item-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:15px; }
.item-card { background:#f8f9fa; padding:15px; border-radius:12px; text-align:center; }
.item-icon { font-size:2.5em; margin-bottom:8px; }
.item-name { font-weight:700; margin-bottom:4px; font-size:0.9em; }
.item-price { color:#f39c12; font-weight:700; margin-bottom:8px; }

/* ORDERS */
.order-card { background:linear-gradient(135deg,#74b9ff,#0984e3); color:white; padding:18px; border-radius:14px; margin-bottom:12px; }
.order-card.active-order { background:linear-gradient(135deg,#55efc4,#00b894); }
.order-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.order-reward { background:rgba(255,255,255,0.3); padding:5px 12px; border-radius:8px; font-weight:700; }
.order-recipe { background:rgba(255,255,255,0.2); padding:8px; border-radius:8px; margin-bottom:10px; font-size:0.9em; }

/* PROFILE */
.profile-center { text-align:center; margin-bottom:25px; }
.avatar { font-size:5em; cursor:pointer; display:inline-block; transition:transform 0.3s; }
.avatar:hover { transform:scale(1.1); }
.player-name { font-size:1.8em; font-weight:700; margin:10px 0; }
.sticker-section { margin-top:20px; }
.sticker-grid-wrap { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:15px; background:#f8f9fa; border-radius:12px; max-height:300px; overflow-y:auto; }
.sticker-item { font-size:1.8em; text-align:center; padding:6px; cursor:pointer; border-radius:8px; border:2px solid transparent; transition:all 0.2s; }
.sticker-item:hover { background:#ffeaa7; transform:scale(1.2); }
.confirm-box { background:#fff3cd; border:2px solid #ffc107; border-radius:12px; padding:20px; text-align:center; margin-bottom:15px; }
.confirm-box p { font-size:1.1em; font-weight:700; margin-bottom:12px; }
.confirm-btns { display:flex; gap:10px; justify-content:center; }

/* FRIENDS */
.search-row { display:flex; gap:10px; margin-bottom:20px; }
.search-row input { flex:1; padding:11px; border:2px solid #ddd; border-radius:10px; font-size:1em; font-family:inherit; outline:none; }
.search-row input:focus { border-color:#0984e3; }
.friend-card { background:#f8f9fa; padding:13px; border-radius:12px; margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; }
.friend-card.request { background:#fff3cd; border:2px solid #ffc107; }
.friend-left { display:flex; align-items:center; gap:12px; }
.friend-avatar { font-size:2.2em; }
.friend-name { font-weight:700; }
.friend-stars { color:#b2bec3; font-size:0.85em; }
.empty { text-align:center; padding:50px 20px; color:#b2bec3; }
.empty-icon { font-size:3.5em; margin-bottom:15px; }

/* CLANS */
.clan-box { background:linear-gradient(135deg,#667eea,#764ba2); padding:25px; border-radius:15px; color:white; margin-bottom:20px; }
.clan-box-header { text-align:center; margin-bottom:20px; }
.clan-big-emoji { font-size:4em; display:block; margin-bottom:8px; }
.clan-big-name { font-size:1.8em; font-weight:700; margin-bottom:5px; }
.clan-member { background:rgba(255,255,255,0.2); padding:10px 14px; border-radius:8px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
.emoji-pick { display:grid; grid-template-columns:repeat(6,1fr); gap:8px; padding:10px; background:#f8f9fa; border-radius:10px; max-height:200px; overflow-y:auto; margin:10px 0; }
.emoji-pick div { font-size:1.8em; text-align:center; padding:6px; cursor:pointer; border-radius:8px; border:2px solid transparent; transition:all 0.2s; }
.emoji-pick div:hover { background:#ffeaa7; transform:scale(1.15); }
.emoji-pick div.picked { border-color:#d63031; background:#ffe0e0; }
.create-clan-form { background:#f8f9fa; padding:20px; border-radius:12px; }
.create-clan-form input { width:100%; padding:11px; border:2px solid #ddd; border-radius:10px; font-size:1em; font-family:inherit; margin-bottom:10px; outline:none; }
.create-clan-form input:focus { border-color:#7B2FBE; }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-box">
    <h2>üêòüçï –ü–æ–∫–æ—Ä–º–∏ –°–ª–æ–Ω–∞!</h2>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin">–í—Ö–æ–¥</button>
      <button class="auth-tab" id="tabRegister">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    <div class="msg error" id="authError"></div>
    <div class="msg success" id="authSuccess"></div>
    <div class="auth-form active" id="loginForm">
      <input type="text" id="loginUser" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
      <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="loginBtn">üîì –í–æ–π—Ç–∏</button>
    </div>
    <div class="auth-form" id="registerForm">
      <input type="text" id="regUser" placeholder="–ò–º—è (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)">
      <input type="password" id="regPass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)">
      <input type="password" id="regPass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª—å">
      <button id="registerBtn">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </div>
  </div>
</div>

<!-- OVEN ANIMATION OVERLAY -->
<div id="ovenOverlay">
  <div class="oven-box">
    <div class="oven-top">üî• –î–£–•–û–í–ö–ê üî•</div>
    <div class="oven-door">
      <div class="oven-glass">
        <div class="oven-fire" id="ovenFire"></div>
        <div class="oven-pizza" id="ovenPizza">üçï</div>
        <div class="oven-sparks" id="ovenSparks"></div>
      </div>
    </div>
    <div class="oven-temp" id="ovenTemp">üå°Ô∏è 200¬∞C</div>
    <div class="oven-progress-wrap">
      <div class="oven-progress" id="ovenProgress"></div>
    </div>
    <div class="oven-status" id="ovenStatus">–†–∞–∑–æ–≥—Ä–µ–≤ –¥—É—Ö–æ–≤–∫–∏...</div>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
  <div class="header">
    <h1>üêò –ü–æ–∫–æ—Ä–º–∏ –°–ª–æ–Ω–∞ –ü–∏—Ü—Ü–æ–π! üçï</h1>
    <div class="stats">
      <div class="stat">‚≠ê –ë–∞–ª–ª—ã: <span id="statScore">0</span></div>
      <div class="stat">üí∞ –ó–≤—ë–∑–¥—ã: <span id="statStars">50</span></div>
      <div class="stat">üë§ <span id="statUser">-</span></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-panel="cookPanel">üçï –ì–æ—Ç–æ–≤–∏—Ç—å</button>
    <button class="tab" data-panel="ordersPanel">üêò –ó–∞–∫–∞–∑—ã</button>
    <button class="tab" data-panel="shopPanel">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="tab" data-panel="invPanel">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
    <button class="tab" data-panel="profilePanel">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="tab" data-panel="friendsPanel">üë• –î—Ä—É–∑—å—è</button>
    <button class="tab" data-panel="clansPanel">üè∞ –ö–ª–∞–Ω—ã</button>
  </div>

  <!-- COOKING -->
  <div class="panel active" id="cookPanel">
    <div class="pizza-wrap">
      <h2 style="margin-bottom:5px;">üçï –ì–æ—Ç–æ–≤–∏–º –ø–∏—Ü—Ü—É!</h2>
      <p id="cookHint" style="color:#b2bec3; font-size:0.9em;">–î–æ–±–∞–≤–ª—è–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏ –ì–æ—Ç–æ–≤–∏—Ç—å!</p>
      <div class="cook-btns" style="margin-top:12px;">
        <button class="btn btn-green" id="cookBtn">üî• –ì–æ—Ç–æ–≤–∏—Ç—å!</button>
        <button class="btn btn-red" id="resetBtn">üîÑ –°–±—Ä–æ—Å</button>
      </div>
      <div class="pizza-circle" id="pizzaCircle"></div>
      <div class="ing-grid" id="ingGrid"></div>
    </div>
  </div>

  <!-- ORDERS -->
  <div class="panel" id="ordersPanel">
    <h2 style="margin-bottom:20px;">üêò –ó–∞–∫–∞–∑—ã —Å–ª–æ–Ω–æ–≤</h2>
    <div id="ordersList"></div>
  </div>

  <!-- SHOP -->
  <div class="panel" id="shopPanel">
    <h2 style="margin-bottom:20px;">üõí –ú–∞–≥–∞–∑–∏–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h2>
    <div class="item-grid" id="shopGrid"></div>
  </div>

  <!-- INVENTORY -->
  <div class="panel" id="invPanel">
    <h2 style="margin-bottom:20px;">üì¶ –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
    <div class="item-grid" id="invGrid"></div>
  </div>

  <!-- PROFILE -->
  <div class="panel" id="profilePanel">
    <div class="profile-center">
      <div class="avatar" id="avatarEl">üçï</div>
      <div class="player-name" id="profileName">-</div>
      <div id="stickerHint" style="color:#b2bec3; margin-bottom:15px;">üëÜ –ù–∞–∂–º–∏ –Ω–∞ –∞–≤–∞—Ç–∞—Ä —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Å—Ç–∏–∫–µ—Ä</div>
      <button class="btn btn-red" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
    </div>
    <div class="sticker-section" id="stickerSection" style="display:none;">
      <h3 style="margin-bottom:10px; text-align:center;">üé® –í—ã–±–µ—Ä–∏ —Å—Ç–∏–∫–µ—Ä</h3>
      <div class="confirm-box" id="stickerConfirm" style="display:none;">
        <p id="stickerConfirmText"></p>
        <div class="confirm-btns">
          <button class="btn btn-green" id="stickerYes">‚úÖ –í—ã–±—Ä–∞—Ç—å!</button>
          <button class="btn btn-red" id="stickerNo">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      <div class="sticker-grid-wrap" id="stickerGridEl"></div>
    </div>
  </div>

  <!-- FRIENDS -->
  <div class="panel" id="friendsPanel">
    <h2 style="margin-bottom:15px;">üë• –î—Ä—É–∑—å—è</h2>
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="–ù–∞–π—Ç–∏ –∏–≥—Ä–æ–∫–∞... (–∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º)">
      <button class="btn btn-blue" id="searchBtn">üîç –ù–∞–π—Ç–∏</button>
    </div>
    <div id="searchResults"></div>
    <hr style="margin:20px 0; border-color:#eee;">
    <h3 style="margin-bottom:12px;">–ú–æ–∏ –¥—Ä—É–∑—å—è (<span id="friendsCount">0</span>)</h3>
    <div id="friendsList"></div>
  </div>

  <!-- CLANS -->
  <div class="panel" id="clansPanel">
    <h2 style="margin-bottom:20px;">üè∞ –ú–æ–π –∫–ª–∞–Ω</h2>
    <div id="clanContent"></div>
  </div>
</div>

<script>
(function() {
'use strict';

// ====== DATA ======
var G = {
  user: null,
  data: null
};

var INGREDIENTS = [
  {name:'–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞', icon:'üçÖ', price:0,  hidden:true},
  {name:'–°—ã—Ä',            icon:'üßÄ', price:0,  hidden:true},
  {name:'–ì—Ä–∏–±—ã',          icon:'üçÑ', price:8},
  {name:'–ü–µ–ø–ø–µ—Ä–æ–Ω–∏',      icon:'ü•ì', price:10},
  {name:'–í–µ—Ç—á–∏–Ω–∞',        icon:'üçñ', price:12},
  {name:'–ê–Ω–∞–Ω–∞—Å',         icon:'üçç', price:7},
  {name:'–õ—É–∫',            icon:'üßÖ', price:4},
  {name:'–û–ª–∏–≤–∫–∏',         icon:'ü´í', price:6},
  {name:'–ú–æ—Ü–∞—Ä–µ–ª–ª–∞',      icon:'üßà', price:9},
  {name:'–ü–µ—Ä–µ—Ü',          icon:'ü´ë', price:6},
  {name:'–ö—É–∫—É—Ä—É–∑–∞',       icon:'üåΩ', price:5},
  {name:'–ö—Ä–µ–≤–µ—Ç–∫–∏',       icon:'ü¶ê', price:15},
  {name:'–Ø–π—Ü–æ',           icon:'üç≥', price:8},
  {name:'–ì–æ–≤—è–¥–∏–Ω–∞',       icon:'ü•©', price:14},
  {name:'–ß–∏–ª–∏',           icon:'üå∂Ô∏è', price:7},
  {name:'–ë–µ–∫–æ–Ω',          icon:'ü•ö', price:11},
  {name:'–®–ø–∏–Ω–∞—Ç',         icon:'üåø', price:5},
  {name:'–ö—Ä–∞–±',           icon:'ü¶Ä', price:18},
  {name:'–¢–æ–º–∞—Ç—ã —á–µ—Ä—Ä–∏',   icon:'ü´ê', price:6},
  {name:'–¢—É–Ω–µ—Ü',          icon:'üêü', price:13},
  {name:'–ê—Ä—Ç–∏—à–æ–∫',        icon:'ü•¶', price:9},
];

var RECIPES = {
  '–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞':     ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä'],
  '–ü–µ–ø–ø–µ—Ä–æ–Ω–∏':     ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ü–µ–ø–ø–µ—Ä–æ–Ω–∏'],
  '–ì–∞–≤–∞–π—Å–∫–∞—è':     ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ê–Ω–∞–Ω–∞—Å','–í–µ—Ç—á–∏–Ω–∞'],
  '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∞—è':['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ì—Ä–∏–±—ã','–õ—É–∫','–û–ª–∏–≤–∫–∏'],
  '–ú—è—Å–Ω–∞—è':        ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ü–µ–ø–ø–µ—Ä–æ–Ω–∏','–í–µ—Ç—á–∏–Ω–∞','–ì–æ–≤—è–¥–∏–Ω–∞'],
  '–ú–æ—Ä—Å–∫–∞—è':       ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ö—Ä–µ–≤–µ—Ç–∫–∏','–û–ª–∏–≤–∫–∏'],
  '–û—Å—Ç—Ä–∞—è':        ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ü–µ–ø–ø–µ—Ä–æ–Ω–∏','–ß–∏–ª–∏','–ü–µ—Ä–µ—Ü'],
  '–î–µ—Ä–µ–≤–µ–Ω—Å–∫–∞—è':   ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ö—É–∫—É—Ä—É–∑–∞','–ü–µ—Ä–µ—Ü','–Ø–π—Ü–æ'],
  '–ö—Ä–∞–±–±–æ–≤–∞—è':     ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ö—Ä–∞–±','–¢–æ–º–∞—Ç—ã —á–µ—Ä—Ä–∏'],
  '–¢—É–Ω–µ—Ü':         ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–¢—É–Ω–µ—Ü','–õ—É–∫','–û–ª–∏–≤–∫–∏'],
  '–ó–µ–ª—ë–Ω–∞—è':       ['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–®–ø–∏–Ω–∞—Ç','–ê—Ä—Ç–∏—à–æ–∫','–ü–µ—Ä–µ—Ü'],
};

var ELEPHANTS = ['–î–∂–∞–º–±–æ','–î–∞–º–±–æ','–≠–ª–ª–∏','–•–æ—Ä—Ç–æ–Ω','–ë–∞–±–∞—Ä','–°–ª–æ–Ω–∏–∫'];
var ORDER_TYPES = [
  {name:'–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞',     ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä'],                                    reward:15},
  {name:'–ü–µ–ø–ø–µ—Ä–æ–Ω–∏',     ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ü–µ–ø–ø–µ—Ä–æ–Ω–∏'],                        reward:25},
  {name:'–ì–∞–≤–∞–π—Å–∫–∞—è',     ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ê–Ω–∞–Ω–∞—Å','–í–µ—Ç—á–∏–Ω–∞'],                 reward:35},
  {name:'–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∞—è',ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ì—Ä–∏–±—ã','–õ—É–∫'],                      reward:30},
  {name:'–ú—è—Å–Ω–∞—è',        ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ü–µ–ø–ø–µ—Ä–æ–Ω–∏','–í–µ—Ç—á–∏–Ω–∞','–ì–æ–≤—è–¥–∏–Ω–∞'],   reward:45},
  {name:'–ú–æ—Ä—Å–∫–∞—è',       ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ö—Ä–µ–≤–µ—Ç–∫–∏','–û–ª–∏–≤–∫–∏'],                reward:50},
  {name:'–û—Å—Ç—Ä–∞—è',        ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ü–µ–ø–ø–µ—Ä–æ–Ω–∏','–ß–∏–ª–∏','–ü–µ—Ä–µ—Ü'],         reward:40},
  {name:'–î–µ—Ä–µ–≤–µ–Ω—Å–∫–∞—è',   ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ö—É–∫—É—Ä—É–∑–∞','–ü–µ—Ä–µ—Ü','–Ø–π—Ü–æ'],         reward:35},
  {name:'–ö—Ä–∞–±–±–æ–≤–∞—è',     ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–ö—Ä–∞–±','–¢–æ–º–∞—Ç—ã —á–µ—Ä—Ä–∏'],              reward:55},
  {name:'–¢—É–Ω–µ—Ü',         ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–¢—É–Ω–µ—Ü','–õ—É–∫','–û–ª–∏–≤–∫–∏'],            reward:45},
  {name:'–ó–µ–ª—ë–Ω–∞—è',       ings:['–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞','–°—ã—Ä','–®–ø–∏–Ω–∞—Ç','–ê—Ä—Ç–∏—à–æ–∫','–ü–µ—Ä–µ—Ü'],        reward:40},
];

var CLAN_EMOJIS = ['üè∞','‚öîÔ∏è','üõ°Ô∏è','üëë','üî•','‚ö°','üíé','üåü','‚≠ê','ü¶Å','üêâ','ü¶Ö','üê∫','üêØ','ü¶à','üê≤','üíÄ','üëπ'];
var STICKERS = [
  'üçï','üêò','üë®‚Äçüç≥','üë∏','ü§¥','ü¶∏','üßô','üßõ','üê∂','üê±','üê≠','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑',
  'üê∏','üêµ','ü¶ä','üêî','üêß','ü¶Ü','‚≠ê','üåü','üí´','‚ú®','üî•','üíß','‚ö°','üåà','‚òÄÔ∏è','üåô','üçî','üå≠','üçó','üçñ',
  'üåÆ','üéÆ','üéØ','üé≤','üé®','üé≠','üèÜ','ü•á','üíé','üí∞','üëë','üé§','üé∏','üé∫','ü¶à','üê≤','üöÄ','üí£','üåä','üé™'
];

var currentPizza = [];
var orders = [];
var selectedStickerEmoji = null;
var selectedClanEmoji = 'üè∞';

// ====== HELPERS ======
function getUsers() { return JSON.parse(localStorage.getItem('pgUsers') || '{}'); }
function saveUsers(u) { localStorage.setItem('pgUsers', JSON.stringify(u)); }
function getClans() { return JSON.parse(localStorage.getItem('pgClans') || '{}'); }
function saveClans(c) { localStorage.setItem('pgClans', JSON.stringify(c)); }

function saveData() {
  if (!G.user) return;
  var u = getUsers();
  u[G.user] = G.data;
  saveUsers(u);
}

function showError(msg) {
  var el = document.getElementById('authError');
  el.textContent = msg; el.classList.add('show');
  setTimeout(function(){ el.classList.remove('show'); }, 3000);
}
function showSuccess(msg) {
  var el = document.getElementById('authSuccess');
  el.textContent = msg; el.classList.add('show');
  setTimeout(function(){ el.classList.remove('show'); }, 3000);
}

function updateStats() {
  document.getElementById('statScore').textContent = G.data.score;
  document.getElementById('statStars').textContent = G.data.stars;
  document.getElementById('statUser').textContent = G.user;
}

// ====== AUTH ======
document.getElementById('tabLogin').onclick = function() {
  document.getElementById('tabLogin').classList.add('active');
  document.getElementById('tabRegister').classList.remove('active');
  document.getElementById('loginForm').classList.add('active');
  document.getElementById('registerForm').classList.remove('active');
};

document.getElementById('tabRegister').onclick = function() {
  document.getElementById('tabRegister').classList.add('active');
  document.getElementById('tabLogin').classList.remove('active');
  document.getElementById('registerForm').classList.add('active');
  document.getElementById('loginForm').classList.remove('active');
};

document.getElementById('loginBtn').onclick = function() {
  var username = document.getElementById('loginUser').value.trim();
  var password = document.getElementById('loginPass').value;
  if (!username || !password) { showError('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!'); return; }
  var users = getUsers();
  if (!users[username]) { showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!'); return; }
  if (users[username].password !== password) { showError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!'); return; }
  G.user = username;
  G.data = users[username];
  localStorage.setItem('pgSession', username);
  startGame();
};

document.getElementById('registerBtn').onclick = function() {
  var username = document.getElementById('regUser').value.trim();
  var pass = document.getElementById('regPass').value;
  var pass2 = document.getElementById('regPass2').value;
  if (username.length < 3) { showError('–ò–º—è –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞!'); return; }
  if (pass.length < 4) { showError('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞!'); return; }
  if (pass !== pass2) { showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!'); return; }
  var users = getUsers();
  if (users[username]) { showError('–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!'); return; }
  users[username] = {
    password: pass, score:0, stars:50,
    inventory:{}, friends:[], friendRequests:[], clan:null,
    sticker:'üçï', stickerLocked:false
  };
  saveUsers(users);
  showSuccess('‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏.');
  setTimeout(function(){
    document.getElementById('tabLogin').click();
    document.getElementById('loginUser').value = username;
  }, 1500);
};

// Enter key in auth
document.getElementById('loginPass').onkeypress = function(e){ if(e.key==='Enter') document.getElementById('loginBtn').click(); };
document.getElementById('regPass2').onkeypress = function(e){ if(e.key==='Enter') document.getElementById('registerBtn').click(); };

// ====== START GAME ======
function startGame() {
  // Always ensure all ingredients exist in inventory
  if (!G.data.inventory) G.data.inventory = {};
  INGREDIENTS.forEach(function(i) {
    if (i.price === 0) {
      G.data.inventory[i.name] = 999; // –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
    } else if (G.data.inventory[i.name] === undefined) {
      G.data.inventory[i.name] = 0;
    }
  });
  saveData();
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('gameScreen').style.display = 'block';
  updateStats();
  renderIngredients();
  renderShop();
  renderInventory();
  generateOrders();
  renderOrders();
  renderProfile();
  renderFriends();
  renderClan();
}

// Check session
(function(){
  var s = localStorage.getItem('pgSession');
  if (s) {
    var users = getUsers();
    if (users[s]) { G.user = s; G.data = users[s]; startGame(); }
  }
})();

// ====== TABS ======
document.querySelectorAll('.tab').forEach(function(tab) {
  tab.onclick = function() {
    document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.panel').forEach(function(p){ p.classList.remove('active'); });
    tab.classList.add('active');
    document.getElementById(tab.getAttribute('data-panel')).classList.add('active');
    // Refresh on tab switch
    var panel = tab.getAttribute('data-panel');
    if (panel === 'friendsPanel') { renderFriends(); searchPlayers(); }
    if (panel === 'clansPanel') renderClan();
    if (panel === 'invPanel') renderInventory();
    if (panel === 'shopPanel') renderShop();
  };
});

// ====== LOGOUT ======
document.getElementById('logoutBtn').onclick = function() {
  localStorage.removeItem('pgSession');
  G.user = null; G.data = null;
  document.getElementById('gameScreen').style.display = 'none';
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
};

// ====== PIZZA ======
function renderIngredients() {
  var grid = document.getElementById('ingGrid');
  grid.innerHTML = '';
  INGREDIENTS.forEach(function(ing) {
    var cnt = G.data.inventory[ing.name] || 0;
    var btn = document.createElement('button');
    btn.className = 'ing-btn';
    btn.disabled = cnt === 0;
    // Special display for tomato paste and cheese
    if (ing.name === '–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞') {
      btn.innerHTML = 'üçÖ<br><span style="font-size:0.5em;font-weight:700;">–ü–∞—Å—Ç–∞</span><span class="cnt">‚àû</span>';
    } else if (ing.name === '–°—ã—Ä') {
      btn.innerHTML = '<span style="font-size:1.5em; display:block; width:40px; height:40px; background:radial-gradient(circle at 35% 35%,#fff176,#fdd835); border-radius:50%; margin:0 auto 4px;"></span><span style="font-size:0.45em;font-weight:700;">–°—ã—Ä</span><span class="cnt">‚àû</span>';
    } else {
      btn.innerHTML = ing.icon + '<span class="cnt">x' + cnt + '</span>';
    }
    btn.title = ing.name;
    btn.onclick = function() { addTopping(ing.name, ing.icon); };
    grid.appendChild(btn);
  });
}

function addTopping(name, icon) {
  var ing = INGREDIENTS.find(function(i){ return i.name === name; });
  if (!ing) return;
  // –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö) –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  if (ing.price > 0 && (G.data.inventory[name] || 0) <= 0) return;
  
  currentPizza.push(name);
  // –£–º–µ–Ω—å—à–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
  if (ing.price > 0) G.data.inventory[name]--;
  
  var pizza = document.getElementById('pizzaCircle');

  if (name === '–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞') {
    // –ö—Ä–∞—Å–Ω—ã–π —Å–æ—É—Å ‚Äî –∑–∞–ª–∏–≤–∞–µ–º –∫—Ä—É–≥–æ–º
    var sauce = document.createElement('div');
    sauce.style.cssText = 'position:absolute;top:8%;left:8%;width:84%;height:84%;border-radius:50%;background:radial-gradient(circle,#e74c3c,#c0392b);opacity:0.85;pointer-events:none;z-index:1;';
    pizza.appendChild(sauce);

  } else if (name === '–°—ã—Ä') {
    // –ñ—ë–ª—Ç—ã–µ –∫—Ä—É–∂–æ—á–∫–∏ —Ä–∞–Ω–¥–æ–º–Ω–æ –ø–æ –≤—Å–µ–π –ø–∏—Ü—Ü–µ
    var count = 12 + Math.floor(Math.random() * 8);
    for (var i = 0; i < count; i++) {
      var circle = document.createElement('div');
      var size = 8 + Math.random() * 18;
      var angle = Math.random() * 2 * Math.PI;
      var r = Math.random() * 40;
      var cx = 50 + r * Math.cos(angle);
      var cy = 50 + r * Math.sin(angle);
      circle.style.cssText = 'position:absolute;border-radius:50%;pointer-events:none;z-index:2;'
        + 'width:' + size + 'px;height:' + size + 'px;'
        + 'left:calc(' + cx + '% - ' + (size/2) + 'px);'
        + 'top:calc(' + cy + '% - ' + (size/2) + 'px);'
        + 'background:radial-gradient(circle at 35% 35%,#fff176,#fdd835);'
        + 'opacity:' + (0.75 + Math.random() * 0.25) + ';';
      pizza.appendChild(circle);
    }

  } else {
    // –ú–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ —Ä–∞–Ω–¥–æ–º–Ω–æ –ø–æ –≤—Å–µ–π –ø–∏—Ü—Ü–µ
    var count2 = 5 + Math.floor(Math.random() * 4);
    for (var j = 0; j < count2; j++) {
      var el = document.createElement('div');
      el.className = 'topping';
      el.textContent = icon;
      var angle2 = Math.random() * 2 * Math.PI;
      var r2 = Math.random() * 38;
      el.style.left = (50 + r2 * Math.cos(angle2)) + '%';
      el.style.top  = (50 + r2 * Math.sin(angle2)) + '%';
      el.style.zIndex = '3';
      el.style.fontSize = (1.2 + Math.random() * 0.8) + 'em';
      el.style.transform = 'translate(-50%,-50%) rotate(' + (Math.random() * 360) + 'deg)';
      pizza.appendChild(el);
    }
  }

  renderIngredients();
  saveData();
}

// ====== RESULT MESSAGE ======
function showResultMsg(text, success) {
  var existing = document.getElementById('resultMsg');
  if (existing) existing.remove();
  var div = document.createElement('div');
  div.id = 'resultMsg';
  div.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);'
    + 'background:' + (success ? 'linear-gradient(135deg,#00b894,#00a383)' : 'linear-gradient(135deg,#d63031,#c0392b)') + ';'
    + 'color:white;padding:30px 40px;border-radius:20px;font-size:1.3em;font-weight:700;'
    + 'font-family:"Comic Sans MS",cursive;text-align:center;z-index:9999;'
    + 'box-shadow:0 20px 60px rgba(0,0,0,0.4);max-width:85vw;'
    + 'transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);';
  div.textContent = text;
  document.body.appendChild(div);
  setTimeout(function(){ div.style.transform = 'translate(-50%,-50%) scale(1)'; }, 10);
  setTimeout(function(){
    div.style.transform = 'translate(-50%,-50%) scale(0)';
    setTimeout(function(){ div.remove(); }, 300);
  }, 2500);
}

// ====== OVEN ANIMATION ======
function runOvenAnimation(callback) {
  var overlay = document.getElementById('ovenOverlay');
  var progress = document.getElementById('ovenProgress');
  var status = document.getElementById('ovenStatus');
  var temp = document.getElementById('ovenTemp');
  var fire = document.getElementById('ovenFire');
  var pizza = document.getElementById('ovenPizza');
  var sparks = document.getElementById('ovenSparks');

  var stages = [
    { pct: 0,   msg: '–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∏—Ü—Ü—É...', t: 'üå°Ô∏è 50¬∞C',  delay: 600  },
    { pct: 20,  msg: '–†–∞–∑–æ–≥—Ä–µ–≤ –¥—É—Ö–æ–≤–∫–∏...', t: 'üå°Ô∏è 100¬∞C', delay: 700  },
    { pct: 40,  msg: 'üî• –í—ã–ø–µ–∫–∞–µ–º!',        t: 'üå°Ô∏è 180¬∞C', delay: 800  },
    { pct: 60,  msg: 'üî• –ö–æ—Ä–æ—á–∫–∞ –∑–æ–ª–æ—Ç–∏—Ç—Å—è!', t:'üå°Ô∏è 220¬∞C', delay: 900 },
    { pct: 80,  msg: 'üßÄ –°—ã—Ä –ø–ª–∞–≤–∏—Ç—Å—è!',    t: 'üå°Ô∏è 250¬∞C', delay: 700  },
    { pct: 95,  msg: '‚ú® –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!',     t: 'üå°Ô∏è 260¬∞C', delay: 600  },
    { pct: 100, msg: 'üéâ –ü–∏—Ü—Ü–∞ –≥–æ—Ç–æ–≤–∞!',     t: 'üå°Ô∏è 260¬∞C', delay: 800  },
  ];

  // Reset
  progress.style.width = '0%';
  fire.style.display = 'block';
  pizza.style.transform = 'translate(-50%,-50%) scale(0.3)';
  pizza.style.opacity = '0';
  sparks.innerHTML = '';

  overlay.classList.add('show');

  // Pizza slides in
  setTimeout(function() {
    pizza.style.transform = 'translate(-50%,-50%) scale(1)';
    pizza.style.opacity = '1';
  }, 200);

  var i = 0;
  var total = 0;
  function nextStage() {
    if (i >= stages.length) {
      // Sparks burst!
      for (var s = 0; s < 18; s++) {
        var sp = document.createElement('div');
        sp.className = 'spark';
        var angle = (s / 18) * 2 * Math.PI;
        var dist = 40 + Math.random() * 40;
        sp.style.setProperty('--sx', Math.cos(angle) * dist + 'px');
        sp.style.setProperty('--sy', Math.sin(angle) * dist + 'px');
        sp.style.left = (50 + Math.cos(angle) * 20) + '%';
        sp.style.top  = (50 + Math.sin(angle) * 20) + '%';
        sparks.appendChild(sp);
        setTimeout(function(){ sp.remove(); }, 800);
      }
      // Pizza grows
      pizza.style.transform = 'translate(-50%,-50%) scale(1.2)';
      setTimeout(function() {
        overlay.classList.remove('show');
        fire.style.display = 'none';
        pizza.style.transform = 'translate(-50%,-50%) scale(1)';
        callback();
      }, 900);
      return;
    }
    var stage = stages[i];
    total += stage.delay;
    setTimeout(function(stg) {
      progress.style.width = stg.pct + '%';
      status.textContent = stg.msg;
      temp.textContent = stg.t;
      // Make pizza spin a bit when hot
      if (stg.pct >= 60) {
        pizza.style.transform = 'translate(-50%,-50%) scale(1.05) rotate(' + (Math.random()*10-5) + 'deg)';
      }
    }, total - stage.delay, stage);
    i++;
    setTimeout(nextStage, stage.delay);
  }
  nextStage();
}

document.getElementById('cookBtn').onclick = function() {
  if (currentPizza.length === 0) { alert('–î–æ–±–∞–≤—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã!'); return; }

  // Disable buttons during animation
  document.getElementById('cookBtn').disabled = true;
  document.getElementById('resetBtn').disabled = true;

  runOvenAnimation(function() {
    document.getElementById('cookBtn').disabled = false;
    document.getElementById('resetBtn').disabled = false;

    // Check active order
    if (G.data.activeOrder !== undefined && G.data.activeOrder !== null) {
      var ord = orders.find(function(o){ return o.id === G.data.activeOrder; });
      if (ord) {
        var sorted1 = currentPizza.slice().sort().join(',');
        var sorted2 = ord.ings.slice().sort().join(',');
        if (sorted1 === sorted2) {
          G.data.score += ord.reward * 5;
          G.data.stars += ord.reward;
          showResultMsg('üéâ –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω! +' + ord.reward + ' –∑–≤—ë–∑–¥!', true);
          orders = orders.filter(function(o){ return o.id !== G.data.activeOrder; });
          G.data.activeOrder = null;
          generateOrders();
          renderOrders();
        } else {
          showResultMsg('‚ùå –ù–µ —Ç–∞ –ø–∏—Ü—Ü–∞! –ù—É–∂–Ω–æ: ' + ord.ings.join(', '), false);
        }
      }
    } else {
      var pts = currentPizza.length * 10;
      var recipe = null;
      for (var r in RECIPES) {
        var s1 = currentPizza.slice().sort().join(',');
        var s2 = RECIPES[r].slice().sort().join(',');
        if (s1 === s2) { recipe = r; pts += 50; G.data.stars += 5; break; }
      }
      G.data.score += pts;
      G.data.stars += Math.floor(pts / 10);
      showResultMsg(recipe ? 'üåü ' + recipe + '! +' + pts + ' –±–∞–ª–ª–æ–≤!' : 'üçï –ü–∏—Ü—Ü–∞ –≥–æ—Ç–æ–≤–∞! +' + pts + ' –±–∞–ª–ª–æ–≤!', true);
    }
    resetPizza();
    updateStats();
    saveData();
  });
};

document.getElementById('resetBtn').onclick = function() {
  resetPizza();
};

function resetPizza() {
  currentPizza = [];
  document.getElementById('pizzaCircle').innerHTML = '';
  renderIngredients();
}

// ====== ORDERS ======
function generateOrders() {
  while (orders.length < 3) {
    var t = ORDER_TYPES[Math.floor(Math.random() * ORDER_TYPES.length)];
    var e = ELEPHANTS[Math.floor(Math.random() * ELEPHANTS.length)];
    orders.push({ id: Date.now() + Math.random(), elephant: e, name: t.name, ings: t.ings, reward: t.reward });
  }
}

function renderOrders() {
  var el = document.getElementById('ordersList');
  if (orders.length === 0) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üêò</div><p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p></div>';
    return;
  }
  el.innerHTML = '';
  orders.forEach(function(ord) {
    var isActive = G.data.activeOrder === ord.id;
    var card = document.createElement('div');
    card.className = 'order-card' + (isActive ? ' active-order' : '');
    card.innerHTML = '<div class="order-top"><div><b>üêò ' + ord.elephant + '</b><br>' + ord.name + '</div><div class="order-reward">‚≠ê ' + ord.reward + '</div></div>'
      + '<div class="order-recipe"><b>–ù—É–∂–Ω–æ:</b> ' + ord.ings.join(', ') + '</div>'
      + '<button class="btn ' + (isActive ? 'btn-red' : 'btn-blue') + '" style="width:100%">'
      + (isActive ? '‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑' : '–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑') + '</button>';
    card.querySelector('button').onclick = function() {
      if (!isActive) { G.data.activeOrder = ord.id; saveData(); renderOrders(); }
    };
    el.appendChild(card);
  });
}

// ====== SHOP ======
function renderShop() {
  var grid = document.getElementById('shopGrid');
  grid.innerHTML = '';
  INGREDIENTS.forEach(function(ing) {
    if (ing.hidden) return; // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–º–∞—Ç–Ω—É—é –ø–∞—Å—Ç—É –∏ —Å—ã—Ä –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞
    var canBuy = G.data.stars >= ing.price;
    var card = document.createElement('div');
    card.className = 'item-card';
    card.innerHTML = '<div class="item-icon">' + ing.icon + '</div>'
      + '<div class="item-name">' + ing.name + '</div>'
      + '<div class="item-price">' + (ing.price === 0 ? '‚àû –ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : ing.price + ' ‚≠ê') + '</div>';
    var btn = document.createElement('button');
    btn.className = 'btn ' + (canBuy ? 'btn-green' : 'btn-red');
    btn.textContent = ing.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : '–ö—É–ø–∏—Ç—å';
    btn.disabled = !canBuy && ing.price > 0;
    btn.onclick = function() {
      if (ing.price > 0 && G.data.stars < ing.price) { alert('–ú–∞–ª–æ –∑–≤—ë–∑–¥!'); return; }
      G.data.stars -= ing.price;
      G.data.inventory[ing.name] = (G.data.inventory[ing.name] || 0) + 1;
      updateStats(); renderShop(); renderInventory(); renderIngredients(); saveData();
    };
    card.appendChild(btn);
    grid.appendChild(card);
  });
}

// ====== INVENTORY ======
function renderInventory() {
  var grid = document.getElementById('invGrid');
  var items = INGREDIENTS.filter(function(i){ return !i.hidden && (G.data.inventory[i.name] || 0) > 0; });
  if (items.length === 0) {
    grid.innerHTML = '<div class="empty"><div class="empty-icon">üì¶</div><p>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç<br>–ö—É–ø–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ!</p></div>';
    return;
  }
  grid.innerHTML = '';
  items.forEach(function(ing) {
    var card = document.createElement('div');
    card.className = 'item-card';
    card.innerHTML = '<div class="item-icon">' + ing.icon + '</div>'
      + '<div class="item-name">' + ing.name + '</div>'
      + '<div class="item-price">x' + G.data.inventory[ing.name] + '</div>';
    grid.appendChild(card);
  });
}

// ====== PROFILE & STICKER ======
function renderProfile() {
  document.getElementById('avatarEl').textContent = G.data.sticker || 'üçï';
  document.getElementById('profileName').textContent = G.user;
  if (G.data.stickerLocked) {
    document.getElementById('stickerHint').textContent = '‚úÖ –°—Ç–∏–∫–µ—Ä –≤—ã–±—Ä–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞';
    document.getElementById('stickerHint').style.color = '#00b894';
  }
}

document.getElementById('avatarEl').onclick = function() {
  if (G.data.stickerLocked) { alert('–°—Ç–∏–∫–µ—Ä —É–∂–µ –≤—ã–±—Ä–∞–Ω –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω—ë–Ω!'); return; }
  var sec = document.getElementById('stickerSection');
  sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
  if (sec.style.display === 'block') buildStickerGrid();
};

function buildStickerGrid() {
  selectedStickerEmoji = null;
  document.getElementById('stickerConfirm').style.display = 'none';
  var grid = document.getElementById('stickerGridEl');
  grid.innerHTML = '';
  STICKERS.forEach(function(s) {
    var div = document.createElement('div');
    div.className = 'sticker-item';
    div.textContent = s;
    div.onclick = function() {
      selectedStickerEmoji = s;
      document.querySelectorAll('.sticker-item').forEach(function(x){ x.style.background=''; x.style.border='2px solid transparent'; });
      div.style.background = '#ffeaa7';
      div.style.border = '2px solid #d63031';
      document.getElementById('stickerConfirmText').textContent = '–í—ã–±—Ä–∞—Ç—å —Å—Ç–∏–∫–µ—Ä ' + s + '? –≠—Ç–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å!';
      document.getElementById('stickerConfirm').style.display = 'block';
    };
    grid.appendChild(div);
  });
}

document.getElementById('stickerYes').onclick = function() {
  if (!selectedStickerEmoji) return;
  G.data.sticker = selectedStickerEmoji;
  G.data.stickerLocked = true;
  document.getElementById('avatarEl').textContent = selectedStickerEmoji;
  document.getElementById('stickerSection').style.display = 'none';
  document.getElementById('stickerConfirm').style.display = 'none';
  document.getElementById('stickerHint').textContent = '‚úÖ –°—Ç–∏–∫–µ—Ä –≤—ã–±—Ä–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞';
  document.getElementById('stickerHint').style.color = '#00b894';
  saveData();
};

document.getElementById('stickerNo').onclick = function() {
  document.getElementById('stickerConfirm').style.display = 'none';
  selectedStickerEmoji = null;
};

// ====== FRIENDS ======
document.getElementById('searchBtn').onclick = function() { searchPlayers(); };
document.getElementById('searchInput').onkeypress = function(e){ if(e.key==='Enter') searchPlayers(); };

function searchPlayers() {
  var query = document.getElementById('searchInput').value.trim().toLowerCase();
  var users = getUsers();
  var res = document.getElementById('searchResults');
  var matches = Object.keys(users).filter(function(u){
    return u !== G.user && (query === '' || u.toLowerCase().includes(query));
  });
  if (matches.length === 0) {
    res.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<br>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π –¥—Ä—É–≥–∞ –∏ –∏—â–∏ –µ–≥–æ –∑–¥–µ—Å—å!</p></div>';
    return;
  }
  res.innerHTML = '<h4 style="margin-bottom:10px;">–ù–∞–π–¥–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤: ' + matches.length + '</h4>';
  matches.forEach(function(username) {
    var isFriend = G.data.friends.includes(username);
    var sentReq = users[username].friendRequests && users[username].friendRequests.includes(G.user);
    var card = document.createElement('div');
    card.className = 'friend-card';
    var sticker = users[username].sticker || 'üçï';
    card.innerHTML = '<div class="friend-left"><div class="friend-avatar">' + sticker + '</div><div><div class="friend-name">' + username + '</div><div class="friend-stars">‚≠ê ' + (users[username].stars||0) + '</div></div></div>';
    var right = document.createElement('div');
    if (isFriend) {
      right.innerHTML = '<span style="color:#00b894;font-weight:700;">‚úÖ –î—Ä—É–∑—å—è</span>';
    } else if (sentReq) {
      right.innerHTML = '<span style="color:#b2bec3;">‚è≥ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>';
    } else {
      var btn = document.createElement('button');
      btn.className = 'btn btn-green';
      btn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å';
      btn.onclick = function() {
        var u2 = getUsers();
        if (!u2[username].friendRequests) u2[username].friendRequests = [];
        if (!u2[username].friendRequests.includes(G.user)) {
          u2[username].friendRequests.push(G.user);
          saveUsers(u2);
          alert('‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ' + username + '!');
          searchPlayers();
        }
      };
      right.appendChild(btn);
    }
    card.appendChild(right);
    res.appendChild(card);
  });
}

function renderFriends() {
  var el = document.getElementById('friendsList');
  document.getElementById('friendsCount').textContent = G.data.friends.length;
  var users = getUsers();
  el.innerHTML = '';

  // Incoming requests
  if (G.data.friendRequests && G.data.friendRequests.length > 0) {
    var reqTitle = document.createElement('h4');
    reqTitle.style.marginBottom = '8px';
    reqTitle.textContent = 'üì¨ –í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:';
    el.appendChild(reqTitle);

    G.data.friendRequests.forEach(function(from) {
      var sticker = users[from] ? (users[from].sticker||'üçï') : 'üçï';
      var card = document.createElement('div');
      card.className = 'friend-card request';
      card.innerHTML = '<div class="friend-left"><div class="friend-avatar">' + sticker + '</div><div class="friend-name">' + from + '</div></div>';
      var btns = document.createElement('div');
      btns.style.cssText = 'display:flex;gap:6px;';
      var yes = document.createElement('button');
      yes.className = 'btn btn-green'; yes.textContent = '‚úÖ –ü—Ä–∏–Ω—è—Ç—å';
      yes.onclick = function() {
        var u2 = getUsers();
        if (!u2[G.user].friends) u2[G.user].friends = [];
        if (!u2[from].friends) u2[from].friends = [];
        u2[G.user].friends.push(from);
        u2[from].friends.push(G.user);
        u2[G.user].friendRequests = u2[G.user].friendRequests.filter(function(x){ return x !== from; });
        saveUsers(u2);
        G.data = u2[G.user];
        renderFriends();
        searchPlayers();
      };
      var no = document.createElement('button');
      no.className = 'btn btn-red'; no.textContent = '‚ùå';
      no.onclick = function() {
        var u2 = getUsers();
        u2[G.user].friendRequests = u2[G.user].friendRequests.filter(function(x){ return x !== from; });
        saveUsers(u2);
        G.data = u2[G.user];
        renderFriends();
      };
      btns.appendChild(yes); btns.appendChild(no);
      card.appendChild(btns);
      el.appendChild(card);
    });

    var hr = document.createElement('hr');
    hr.style.margin = '12px 0';
    el.appendChild(hr);
  }

  if (G.data.friends.length === 0) {
    var empty = document.createElement('div');
    empty.className = 'empty';
    empty.innerHTML = '<div class="empty-icon">üë•</div><p>–ù–µ—Ç –¥—Ä—É–∑–µ–π –ø–æ–∫–∞<br>–í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã –≤—ã—à–µ!</p>';
    el.appendChild(empty);
  } else {
    G.data.friends.forEach(function(fname) {
      var fu = users[fname];
      var sticker = fu ? (fu.sticker||'üçï') : 'üçï';
      var card = document.createElement('div');
      card.className = 'friend-card';
      card.innerHTML = '<div class="friend-left"><div class="friend-avatar">' + sticker + '</div><div><div class="friend-name">' + fname + '</div><div class="friend-stars">‚≠ê ' + (fu ? fu.stars : 0) + '</div></div></div>';
      var btn = document.createElement('button');
      btn.className = 'btn btn-red'; btn.textContent = 'üóëÔ∏è';
      btn.onclick = function() {
        var u2 = getUsers();
        u2[G.user].friends = u2[G.user].friends.filter(function(x){ return x !== fname; });
        if (u2[fname]) u2[fname].friends = u2[fname].friends.filter(function(x){ return x !== G.user; });
        saveUsers(u2);
        G.data = u2[G.user];
        renderFriends();
        searchPlayers();
      };
      card.appendChild(btn);
      el.appendChild(card);
    });
  }
}

// ====== CLANS ======
function renderClan() {
  var el = document.getElementById('clanContent');
  var clans = getClans();

  if (!G.data.clan) {
    el.innerHTML = '';
    var empty = document.createElement('div');
    empty.className = 'empty';
    empty.innerHTML = '<div class="empty-icon">üè∞</div><p>–£ —Ç–µ–±—è –Ω–µ—Ç –∫–ª–∞–Ω–∞</p>';
    el.appendChild(empty);

    var form = document.createElement('div');
    form.className = 'create-clan-form';
    form.innerHTML = '<h3 style="margin-bottom:12px;">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω</h3>'
      + '<input type="text" id="clanNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)">'
      + '<p style="margin-bottom:8px; font-weight:700;">–í—ã–±–µ—Ä–∏ —ç–º–æ–¥–∑–∏:</p>';
    var pick = document.createElement('div');
    pick.className = 'emoji-pick';
    CLAN_EMOJIS.forEach(function(e) {
      var d = document.createElement('div');
      d.textContent = e;
      if (e === selectedClanEmoji) d.classList.add('picked');
      d.onclick = function() {
        selectedClanEmoji = e;
        document.querySelectorAll('.emoji-pick div').forEach(function(x){ x.classList.remove('picked'); });
        d.classList.add('picked');
      };
      pick.appendChild(d);
    });
    form.appendChild(pick);
    var btn = document.createElement('button');
    btn.className = 'btn btn-green'; btn.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω';
    btn.style.marginTop = '12px'; btn.style.width = '100%';
    btn.onclick = function() {
      var name = document.getElementById('clanNameInput').value.trim();
      if (name.length < 3) { alert('–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞!'); return; }
      var clans2 = getClans();
      var id = 'clan_' + Date.now();
      clans2[id] = { name:name, emoji:selectedClanEmoji, leader:G.user, members:[G.user] };
      saveClans(clans2);
      G.data.clan = id;
      saveData();
      renderClan();
      alert('‚úÖ –ö–ª–∞–Ω "' + name + '" —Å–æ–∑–¥–∞–Ω!');
    };
    form.appendChild(btn);
    el.appendChild(form);
    return;
  }

  var clan = clans[G.data.clan];
  if (!clan) { G.data.clan = null; saveData(); renderClan(); return; }
  var isLeader = clan.leader === G.user;

  el.innerHTML = '';
  var box = document.createElement('div');
  box.className = 'clan-box';
  box.innerHTML = '<div class="clan-box-header"><span class="clan-big-emoji">' + clan.emoji + '</span><div class="clan-big-name">' + clan.name + '</div><p>' + clan.members.length + ' —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>'
    + '<h4 style="margin-bottom:10px;">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏:</h4>';
  clan.members.forEach(function(m) {
    var users = getUsers();
    var msticker = users[m] ? (users[m].sticker||'üçï') : 'üçï';
    var row = document.createElement('div');
    row.className = 'clan-member';
    row.innerHTML = '<span>' + msticker + ' ' + m + (m === clan.leader ? ' üëë' : '') + '</span>';
    if (isLeader && m !== G.user) {
      var rb = document.createElement('button');
      rb.className = 'btn btn-red'; rb.textContent = '–£–¥–∞–ª–∏—Ç—å'; rb.style.padding = '5px 10px';
      rb.onclick = function() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å ' + m + ' –∏–∑ –∫–ª–∞–Ω–∞?')) return;
        var c2 = getClans(); var u2 = getUsers();
        c2[G.data.clan].members = c2[G.data.clan].members.filter(function(x){ return x !== m; });
        if (u2[m]) u2[m].clan = null;
        saveClans(c2); saveUsers(u2);
        renderClan();
      };
      row.appendChild(rb);
    }
    box.appendChild(row);
  });
  el.appendChild(box);

  // Leave / Disband
  var leaveBtn = document.createElement('button');
  leaveBtn.className = 'btn btn-red'; leaveBtn.style.width = '100%'; leaveBtn.style.marginTop = '12px';
  leaveBtn.textContent = isLeader ? 'üóëÔ∏è –†–∞—Å–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞–Ω' : 'üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–ª–∞–Ω';
  leaveBtn.onclick = function() {
    if (!confirm(isLeader ? '–†–∞—Å–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞–Ω?' : '–ü–æ–∫–∏–Ω—É—Ç—å –∫–ª–∞–Ω?')) return;
    var c2 = getClans(); var u2 = getUsers();
    if (isLeader) {
      c2[G.data.clan].members.forEach(function(m){ if(u2[m]) u2[m].clan = null; });
      delete c2[G.data.clan];
    } else {
      c2[G.data.clan].members = c2[G.data.clan].members.filter(function(x){ return x !== G.user; });
      u2[G.user].clan = null;
    }
    saveClans(c2); saveUsers(u2);
    G.data.clan = null; saveData();
    renderClan();
  };
  el.appendChild(leaveBtn);
}

})();
</script>
</body>
</html>
